{% extends "layout.html" %}

{% block title %}My Wallet - Hakeem Inventory{% endblock %}
{% block page_title %}My Wallet{% endblock %}

{% block content %}
<div class="row g-4">
    <!-- Wallet Balance & Add Money -->
    <div class="col-lg-4">
        <!-- Balance Card -->
        <div class="card border-0 shadow-sm mb-4"
            style="background: linear-gradient(135deg, #232f3e 0%, #37475a 100%); color: white;">
            <div class="card-body p-4">
                <div class="d-flex justify-content-between align-items-start mb-3">
                    <div>
                        <h6 class="text-white-50 text-uppercase fw-bold small mb-1">Available Balance</h6>
                        <h2 class="display-5 fw-bold mb-0">₹<span id="balanceDisplay">{{ "{:,.2f}".format(balance)
                                }}</span></h2>
                    </div>
                    <div class="bg-white bg-opacity-10 rounded-circle p-3">
                        <i class="fas fa-wallet fa-2x text-warning"></i>
                    </div>
                </div>
                <div
                    class="d-flex justify-content-between text-white-50 border-top border-white border-opacity-10 pt-3 mt-3">
                    <div class="text-center">
                        <small class="d-block small text-uppercase">Total Added</small>
                        <span class="fw-bold text-white">₹{{ "{:,.2f}".format(total_credit) }}</span>
                    </div>
                    <div class="text-center">
                        <small class="d-block small text-uppercase">Total Spent</small>
                        <span class="fw-bold text-white">₹{{ "{:,.2f}".format(total_debit) }}</span>
                    </div>
                </div>
            </div>
        </div>

        <!-- Add Money Card -->
        <div class="card border-0 shadow-sm">
            <div class="card-header bg-white border-0 py-3">
                <h5 class="fw-bold mb-0"><i class="fas fa-plus-circle me-2 text-primary"></i>Add Money</h5>
            </div>
            <div class="card-body p-4 pt-0">
                <form action="{{ url_for('wallet') }}" method="POST" id="addMoneyForm">
                    <input type="hidden" name="method" id="paymentMethod" value="UPI">

                    <div class="mb-4">
                        <label class="form-label text-muted small fw-bold">ENTER AMOUNT</label>
                        <div class="input-group input-group-lg">
                            <span class="input-group-text border-0 bg-light fw-bold">₹</span>
                            <input type="number" name="amount" id="amountInput"
                                class="form-control border-0 bg-light fw-bold fs-4" placeholder="0.00" min="1"
                                step="0.01" required>
                        </div>
                    </div>

                    <div class="d-grid gap-2 mb-4">
                        <div class="btn-group" role="group">
                            <button type="button" class="btn btn-outline-secondary btn-sm amount-preset"
                                data-amount="100">+ ₹100</button>
                            <button type="button" class="btn btn-outline-secondary btn-sm amount-preset"
                                data-amount="500">+ ₹500</button>
                            <button type="button" class="btn btn-outline-secondary btn-sm amount-preset"
                                data-amount="1000">+ ₹1,000</button>
                            <button type="button" class="btn btn-outline-secondary btn-sm amount-preset"
                                data-amount="5000">+ ₹5,000</button>
                        </div>
                    </div>

                    <div class="mb-3">
                        <label class="form-label text-muted small fw-bold">PAYMENT METHOD</label>
                        <div class="p-3 border rounded bg-light">
                            <div class="form-check mb-2">
                                <input class="form-check-input" type="radio" name="payment_opt" id="payUPI" checked>
                                <label class="form-check-label fw-bold d-flex justify-content-between w-100"
                                    for="payUPI">
                                    <span>UPI / QR Code</span>
                                    <i class="fas fa-qrcode text-muted"></i>
                                </label>
                            </div>
                            <div class="form-check">
                                <input class="form-check-input" type="radio" name="payment_opt" id="payHandCash">
                                <label class="form-check-label fw-bold d-flex justify-content-between w-100"
                                    for="payHandCash">
                                    <span>Hand Cash</span>
                                    <i class="fas fa-money-bill-wave text-muted"></i>
                                </label>
                            </div>
                        </div>
                    </div>

                    <!-- Dynamic QR Code Section -->
                    <div id="qrSection" class="text-center p-3 mb-3 bg-white border border-warning rounded d-none">
                        <div class="mb-2">
                            <div class="spinner-border spinner-border-sm text-warning" role="status" id="qrSpinner">
                            </div>
                            <img src="" id="upiQrCode" alt="Scan to Pay" class="img-fluid rounded d-none"
                                style="max-height: 200px;">
                        </div>
                        <p class="small text-muted mb-1">Scan with any UPI App</p>
                        <div
                            class="d-flex align-items-center justify-content-center bg-light rounded p-2 border border-dashed">
                            <span class="font-monospace small text-dark me-2" id="upiIdDisplay">merchant@upi</span>
                            <button type="button" class="btn btn-link btn-sm p-0 text-decoration-none"
                                onclick="copyUpi()">
                                <i class="far fa-copy"></i>
                            </button>
                        </div>
                    </div>

                    <div class="d-grid">
                        <button type="button" id="proceedBtn" class="btn btn-warning btn-lg fw-bold text-dark shadow-sm"
                            style="background-color: #f0c14b; border-color: #a88734;">
                            Proceed to Add Money
                        </button>
                        <button type="submit" id="confirmBtn" class="btn btn-success btn-lg fw-bold shadow-sm d-none">
                            <i class="fas fa-check me-2"></i>Confirm Payment
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Transaction History -->
    <div class="col-lg-8">
        <div class="card border-0 shadow-sm h-100">
            <div class="card-header bg-white py-3 border-0 d-flex justify-content-between align-items-center">
                <h5 class="fw-bold mb-0">Transaction History</h5>
                <button class="btn btn-sm btn-outline-secondary"><i class="fas fa-download me-1"></i> Statement</button>
            </div>
            <div class="table-responsive">
                <table class="table table-hover align-middle mb-0">
                    <thead class="bg-light text-muted small text-uppercase">
                        <tr>
                            <th class="ps-4">Date</th>
                            <th>Description</th>
                            <th>Reference</th>
                            <th class="text-end">Amount</th>
                            <th class="text-center pe-4">Actions</th>
                        </tr>
                    </thead>
                    <tbody class="border-top-0">
                        {% for txn in transactions %}
                        <tr>
                            <td class="ps-4" style="width: 20%;">
                                <div class="fw-bold text-dark">{{ txn.created_at.strftime('%d %b %Y') }}</div>
                                <small class="text-muted">{{ txn.created_at.strftime('%I:%M %p') }}</small>
                            </td>
                            <td>
                                <div class="d-flex align-items-center">
                                    <div class="rounded-circle bg-light p-2 me-3 d-flex align-items-center justify-content-center"
                                        style="width: 40px; height: 40px;">
                                        <i
                                            class="fas fa-{{ 'arrow-down text-success' if txn.type == 'CREDIT' else 'shopping-cart text-danger' }}"></i>
                                    </div>
                                    <div>
                                        <div class="fw-bold text-dark">
                                            {{ 'Money Added' if txn.type == 'CREDIT' else 'Purchase / Debit' }}
                                        </div>
                                        <small class="text-muted">{{ txn.payment_method }} • {{ txn.status }}</small>
                                    </div>
                                </div>
                            </td>
                            <td class="font-monospace small text-muted">{{ txn.transaction_id }}</td>
                            <td class="text-end">
                                <span class="fw-bold text-{{ 'success' if txn.type == 'CREDIT' else 'danger' }}">
                                    {{ '+' if txn.type == 'CREDIT' else '-' }}₹{{ "{:,.2f}".format(txn.amount) }}
                                </span>
                            </td>
                            <td class="text-center pe-4">
                                <div class="dropdown">
                                    <button class="btn btn-sm btn-light border-0 shadow-none p-1" type="button"
                                        data-bs-toggle="dropdown">
                                        <i class="fas fa-ellipsis-v text-muted"></i>
                                    </button>
                                    <ul class="dropdown-menu dropdown-menu-end border-0 shadow-sm">
                                        <li>
                                            <a class="dropdown-item py-2 edit-txn-btn" href="#" data-id="{{ txn.id }}"
                                                data-amount="{{ txn.amount }}" data-type="{{ txn.type | replace('"', '
                                                &quot;') }}" data-method="{{ txn.payment_method | replace('"', '
                                                &quot;') }}">
                                                <i class="fas fa-edit me-2 text-primary"></i>Edit
                                            </a>
                                        </li>
                                        <li>
                                            <hr class="dropdown-divider">
                                        </li>
                                        <li>
                                            <a class="dropdown-item py-2 text-danger"
                                                href="{{ url_for('delete_wallet_transaction', id=txn.id) }}"
                                                onclick="return confirm('Are you sure you want to delete this transaction? This will also adjust your balance.')">
                                                <i class="fas fa-trash-alt me-2"></i>Delete
                                            </a>
                                        </li>
                                    </ul>
                                </div>
                            </td>
                        </tr>
                        {% else %}
                        <tr>
                            <td colspan="5" class="text-center py-5">
                                <i class="fas fa-receipt fa-3x text-muted mb-3 opacity-25"></i>
                                <p class="text-muted">No transactions found.</p>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>

<!-- Edit Transaction Modal -->
<div class="modal fade" id="editModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content border-0 shadow-lg">
            <div class="modal-header bg-primary text-white border-0">
                <h5 class="modal-title fw-bold"><i class="fas fa-edit me-2"></i>Correct Transaction</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <form id="editForm" method="POST">
                <div class="modal-body p-4">
                    <div class="mb-3">
                        <label class="form-label small fw-bold text-muted">AMOUNT</label>
                        <div class="input-group">
                            <span class="input-group-text bg-light border-0">₹</span>
                            <input type="number" name="amount" id="editAmount"
                                class="form-control bg-light border-0 fw-bold" step="0.01" required>
                        </div>
                    </div>
                    <div class="mb-3">
                        <label class="form-label small fw-bold text-muted">TYPE</label>
                        <select name="type" id="editType" class="form-select bg-light border-0 fw-bold">
                            <option value="CREDIT">Money Added (Credit)</option>
                            <option value="DEBIT">Purchase / Debit</option>
                        </select>
                    </div>
                    <div class="mb-0">
                        <label class="form-label small fw-bold text-muted">PAYMENT METHOD</label>
                        <select name="method" id="editMethod" class="form-select bg-light border-0 fw-bold">
                            <option value="UPI">UPI / QR Code</option>
                            <option value="Hand Cash">Hand Cash</option>
                        </select>
                    </div>
                </div>
                <div class="modal-footer border-0 p-4 pt-0">
                    <button type="button" class="btn btn-light fw-bold" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-primary fw-bold px-4">Save Changes</button>
                </div>
            </form>
        </div>
    </div>
</div>

<script>
    document.addEventListener('DOMContentLoaded', function () {
        const amountInput = document.getElementById('amountInput');
        const qrSection = document.getElementById('qrSection');
        const upiQrCode = document.getElementById('upiQrCode');
        const qrSpinner = document.getElementById('qrSpinner');
        const proceedBtn = document.getElementById('proceedBtn');
        const confirmBtn = document.getElementById('confirmBtn');
        const upiId = "merchant@upi";

        // Preset Amounts
        document.querySelectorAll('.amount-preset').forEach(btn => {
            btn.addEventListener('click', function () {
                amountInput.value = this.dataset.amount;
                // Trigger change if needed
            });
        });

        // Generate QR Code Logic
        proceedBtn.addEventListener('click', function () {
            const amount = parseFloat(amountInput.value);
            if (!amount || amount <= 0) {
                alert("Please enter a valid amount");
                return;
            }

            const method = document.getElementById('payUPI').checked ? 'UPI' : 'Hand Cash';
            document.getElementById('paymentMethod').value = method;

            if (method === 'UPI') {
                // Show QR Section
                qrSection.classList.remove('d-none');
                // Generate QR
                const upiUrl = `upi://pay?pa=${upiId}&pn=Hakeem%20Inventory&am=${amount}&cu=INR`;
                const qrApi = `https://api.qrserver.com/v1/create-qr-code/?size=200x200&data=${encodeURIComponent(upiUrl)}`;

                upiQrCode.onload = function () {
                    qrSpinner.classList.add('d-none');
                    upiQrCode.classList.remove('d-none');
                };
                upiQrCode.src = qrApi;
            } else {
                qrSection.classList.add('d-none');
            }

            proceedBtn.classList.add('d-none');
            confirmBtn.classList.remove('d-none');
        });

        window.copyUpi = function () {
            navigator.clipboard.writeText(upiId).then(() => {
                alert("UPI ID copied to clipboard!");
            });
        };

        // Edit Transaction Logic
        document.querySelectorAll('.edit-txn-btn').forEach(btn => {
            btn.addEventListener('click', function (e) {
                e.preventDefault();
                const id = this.dataset.id;
                const amount = this.dataset.amount;
                const type = this.dataset.type;
                const method = this.dataset.method;

                const modal = new bootstrap.Modal(document.getElementById('editModal'));
                document.getElementById('editForm').action = `/wallet/edit/${id}`;
                document.getElementById('editAmount').value = amount;
                document.getElementById('editType').value = type;
                document.getElementById('editMethod').value = method;
                modal.show();
            });
        });
    });
</script>
{% endblock %}